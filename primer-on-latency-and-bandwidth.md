# 速度是特性

最近几年里，网络性能优化（WPO）的出现和快速增长，表现出用户对于响应快速的用户体验的需求。这不仅仅是简单是加速连接世界带来的 “我们需要速度” 的心理作用，而是由实际经验显示出的需求。这些经验来自于对许多在线业务的底线性能的衡量。

* 更快的网站带来更高的用户参与度
* 更快的网站带来更高的用户留存
* 更快的网站带来更高的用户转换率

简单来说，速度是一个特性。为了实现这一点，我们需要去理解许多关于性能的因素和底层限制。在这一章中，我们会关注与两个描述所有网络流量的关键因素：延迟和带宽。

_延迟_

从信息源发送数据包到目的地接收到该数据包所需要的时间

_带宽_

逻辑或物理通道的最大吞吐量

![](/assets/import.png)

_图1-1 延迟和带宽_

为了更好的理解带宽和延迟是如何联系在一起的，在接下来有关 TCP， UDP 和所有应用层协议的章节中，我们会使用它们作为工具，深入挖掘其中的价值。

> **使用爱尔兰高速网络\(Hibernia Express\)降低跨洋延迟**
>
> 在金融领域中，对于高频交易算法来说延迟是一个重要的标准，几毫秒的变化会造成数百万的损失或者利润。
>
> 在 2015 年九月，爱尔兰网络下水了新的光纤网络\(Hibernia Express\)，这个网络设计用来确保纽约到伦敦的延迟最低。该项目的最低费用估计在三十亿美元之上，新的线路使得这两个城市之间的延迟达到了 58.95 ms，比所有现存的网络提升约 5 ms 左右，相当于每节约一毫秒需要花费至少 6 千万美元。
>
> 延迟是昂贵的 - 无论是字面上还是实际意义上

# 延迟的许多组成部分

延迟指的是消息或者数据包从源点到目的点的时间。这是一个简单又有用的定义，但是它隐藏了很多有用的信息。每一个系统都包含了很多的源或者组成部分，这些都在传递信息的过程中占用了一定的时间，理解哪些部分占用了时间对于描述系统性能是十分关键的。

让我们更仔细的了解一下在典型的互联网线路中常见的组成部分，了解它们在信息传递中的责任。

_传播延迟_

信息在发送者和接受者之间传播所需要的时间，这部分时间由距离和信号传递的速度决定。

_发送延迟_

将数据包中的所有比特放进线路中所需要的时间，这部分时间由数据包的长度和线路的数据速率决定。

_处理延迟_

处理数据包包头所需要的时间，用于检查比特级别的错误并且确定数据包的目的地。

_等待延迟_

数据包在队列中等待处理的时间。

客户端和服务器之间的总延迟由上述延迟组合而成。传播时间由距离和信号传播的介质觉得，正如我们看到的那样，传播速度通常是光速和一些其他很小的因素。另一方面，发送延迟由可用的传输线路的数据速率决定，和客户端到服务器的距离无关。举例来说，我们假设在 1 Mbps 和 100 Mbps 这两种线路中传送一个 10 Mb 的文件。在 1 Mbps 的线路中会花费 10 秒， 而在 100 Mbps 的线路中只需要 0.1 秒。

**注意**
> 网络的数据传输速率通常用每秒钟传输的比特数来计算的（bps），相反，在非网络相关的设备中数据传输速率通常使用字节每秒（Bps）来表示。注意单位上的差距，这通常会造成一些困惑。

接下来，一旦数据包到达路由器，路由器会通过检查包头来确定如何送到下一个路由器还可能做一些其他方面的检查，这些操作都会占用一定的时间。大多数这些操作逻辑是通过硬件完成的，使得占用的时间会很小，但是它们确实存在。最终，如果数据包到达的速率比路由器处理的速度还要快得话，这些数据包会在输入缓冲中等待。在输入缓冲中等待的时间被称作等待延迟。

> **本地路由器的缓存过满**
> 
> 缓存过满（bufferbloat）是由 Jim Gettys 在 2010 年提出的一个术语，是一个等待延迟影响整个网络性能的很好的例子。
> 在所有情况下数据包都不应该丢掉这一假设造成的潜在问题是很多的路由器都有很大的输入缓存。然而这导致了 TCP 的拥塞控制机制（我们在下一章介绍）并且会引入多变的等待延迟到网络中。
> 好消息是用来解决这一问题的 CoDel 主动队列管理的新算法已经被提出，并且已经在 Linux 3.5 以上的内核中实现。你可以在 ["控制等待延迟"](https://hpbn.co/aqmacm) 了解到更多信息。

# 光速和传播延迟
正如爱因斯坦在相对论中提出的那样，攻速是所有物质，能量和信息所能达到的最高速度。这是一个数据包在网络传播中所需时间的明显的限制。

好消息是光速是很快的，能到达每秒 299，792，458米，或者 186，282 英里。然而，这是光速在真空中的速度。相反，我们的数据包需要在如铜线或者光纤这些的介质中传播，这会使信号传递的速度变慢，如表1-1中所示。数据包在真空中和在介质中传播的速度的比被称作介质的折射率。折射率越大，传播的速度越慢。

线路       | 距离   | 真空中的时间| 光纤中的时间| 光纤中来回所需的时间（RTT）
----------| ------ |----------|------------|----------------
纽约到三番  |4，148km|14ms|21ms|42ms
纽约到伦敦  |5，585km|19ms|28ms|56ms
纽约到悉尼  |15，993km|53ms|80ms|160ms
赤道周长    |40,075ms|133.7ms|200ms|200ms
表 1-1 信号在真空中和在光纤中的延迟

我们长距离的传输数据包所使用的介质通常是光纤，它折射率在 1.4 到 1.6 之间不等，虽然有点低，但是我们再不断的提升介质的质量来降低折射率。简单来说，光在光纤中的速度大约是 200，000，000 米每秒，相应的折射率大约是 1.5。值得注意的是，我们已经相当接近能够实现的最大速度，这不能不称为是一个令人惊奇的成就。

虽然光的速度很快，但是从纽约到悉尼一个来回也需要大概 160 ms 左右。 表 1-1 中的数据依旧是在假设数据包在两者之间的有一个大圆弧连接（在球上两点的最短距离）的理想情况下的数据。实际上这几乎是不可能的，纽约和悉尼之间的数据包会通过比理想状态下远的多的距离。在这一线路中的每一跳都会带来额外的路由，传输，等待，处理延迟。结果就是在纽约和悉尼之间已经存在的线路的 RTT 在 200 到 300 毫秒之间。这些情况都考虑上，这依旧挺快的，不是么？

我们还不习惯使用毫秒来描述日常事务，但是研究表明人民会注意到系统中超过 100-200 毫秒的延迟。一旦有超过 300 毫秒的延迟，交互便不是那么的流畅。当有 1000 毫秒的延迟出现，许多用户会在等待响应的时候去做其他事情，[速度，性能和人类感知](https://hpbn.co/primer-on-web-performance/#speed-performance-and-human-perception)中有更详细的描述。

简答来说，为了提供最好的体验并且保持用于一直处于使用状态，需要我们的应用在数百毫秒中响应。这会一直伴随着我们，尤其在网络中，甚至比发生错误更加重要。成功的网络一定要认真对待网络延迟，并且将网络延迟作为一个明显的设计标准在开发的每个阶段。

**note**
> 内容分发网络(CDN)提供了很多的优点，最显而易见的是它在全球分发内容，提供给用户最近的内容，这就大大降低了所有数据包的传播延迟。
> 我们不能让数据包传递的更快，但是我们能通过让服务器离用户更近来减低数据包传递的距离。使用 CDN 来提供数据可以大大提高性能。

# 最后一英里延迟
臭名昭著的最后一英里问题指的是在传输过程中，显著的延迟不是由跨越大洋或大陆造成的，而是最后几英里造成的。为了将你的家或办公室连接到互联网上，当地的 ISP 需要通过电缆将你的邻居的信号汇总起来并将其转发到局部路由节点。实际上，取决于连接的类型、路由的结构、部署的技术等，开始的几跳通常会占用几十毫秒。

根据每年有美国联邦通讯委员会（FCC）做出的 “测量美国带宽” 的报道，最后一英里延迟在美国国内还是相对稳定的。光纤有最好的平均性能 （10-20 ms），接下来是电缆（15-40 ms）和 DSL （30-65 ms）。

